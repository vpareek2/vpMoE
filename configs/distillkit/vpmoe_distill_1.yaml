project_name: vpmoe-stage1-distill
model: veerpareek/vpmoe-20b-init
trust_remote_code: true
model_kwargs:
    use_cache: false
    use_kernels: false

frozen_res: # regex param names for frozen weights
    - ^model\.embed_tokens
    - ^lm_head
    - ^model\.norm\.weight$
    - ^model\.layers\.\d+\.input_layernorm\.weight$
    - ^model\.layers\.\d+\.post_attention_layernorm\.weight$
    - ^model\.layers\.\d+\.mlp\.

output_path: /data/distill_runs/vpmoe_stage1_4k_gbs256
use_flash_attention: true
sequence_length: 4096
resize_embeddings_to_multiple_of: 201088

dataset:
    train_dataset:
        disk_path: /data/distillation_1/phase1_mix_4k_665m
        split: train
    eval_dataset:
        disk_path: /data/distillation_1/phase1_mix_4k_665m
        split: validation
    seed: 12
    num_eval_samples: 64

loss_functions:
    - function: cross_entropy
      weight: 0.2
    - function: kl
      weight: 0.2
      temperature: 2.0
    - function: hs_cosine # cosine loss between hidden states
      weight: 0.6

layer_mapping: all

teacher:
    kind: hf
    path: openai/gpt-oss-20b
    kwargs:
        attn_implementation: flash_attention_2
        use_cache: false
        device_map: "cuda"

training_args:
    dataset_kwargs:
        skip_prepare_dataset: true
    packing: false
    num_train_epochs: 1
    per_device_train_batch_size: 1
    # 8 GPUs * microbatch 1 * grad_accum 32 = global batch 256
    gradient_accumulation_steps: 32

    dataloader_num_workers: 4
    dataloader_pin_memory: true
    dataloader_persistent_workers: true
    dataloader_drop_last: true
    # Conservative cadence so we get signal early in a "one-shot" run.
    eval_steps: 100
    per_device_eval_batch_size: 1
    save_steps: 200
    save_total_limit: 3
    logging_steps: 1
    remove_unused_columns: false

    learning_rate: 3.0e-4
    weight_decay: 0.1
    warmup_ratio: 0.025
    lr_scheduler_type: cosine_with_min_lr
    lr_scheduler_kwargs:
        min_lr: 1.0e-5

    bf16: true
    tf32: true
    max_grad_norm: 0.5
    optim: adamw_torch
    optim_args: "muon,lr=0.02,wd=0.1,update_scale=0.2,momentum=0.95,nesterov=true,ns_steps=5,adamw_lr=3e-4,adamw_wd=0.1"

    gradient_checkpointing: true
    gradient_checkpointing_kwargs:
        use_reentrant: false
