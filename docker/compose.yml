services:
  vpmoe:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        # Override per-machine if needed:
        #   VPMOE_BASE_IMAGE=nvcr.io/nvidia/pytorch:<tag>
        BASE_IMAGE: ${VPMOE_BASE_IMAGE:-nvcr.io/nvidia/vllm:25.12.post1-py3}
    image: vpmoe:latest
    working_dir: /workspace/vpmoe
    volumes:
      - ..:/workspace/vpmoe
      # Canonical host mounts (no per-machine compose overrides):
      #   /data      -> writable workspace (caches, checkpoints, derived datasets)
      #   /datasets  -> optional read-only raw datasets
      - /data:/data
      - /datasets:/datasets:ro
    environment:
      HF_HOME: /data/hf_cache
      HF_TOKEN: ${HF_TOKEN:-}
      HUGGING_FACE_HUB_TOKEN: ${HUGGING_FACE_HUB_TOKEN:-}
      TIKTOKEN_ENCODINGS_BASE: /data/hf_cache/tiktoken-encodings
      TIKTOKEN_RS_CACHE_DIR: /data/hf_cache/tiktoken-rs-cache
      # NGC images can enforce GPU allowlists; DGX Spark (GB10) may require bypass.
      NVIDIA_DISABLE_REQUIRE: '1'
    gpus: all
    ipc: host
    command: ["sleep", "infinity"]
