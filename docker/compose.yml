services:
  vpmoe:
    image: ${VPMOE_IMAGE:-ghcr.io/vpareek2/vpmoe:main}
    platform: linux/amd64
    pull_policy: always
    working_dir: /workspace/vpmoe
    volumes:
      - ..:/workspace/vpmoe
      # Canonical host mounts (no per-machine compose overrides):
      #   /data      -> writable workspace (caches, checkpoints, derived datasets)
      #   /datasets  -> optional read-only raw datasets
      - /data:/data
      - /datasets:/datasets:ro
    environment:
      HF_HOME: /data/hf_cache
      HF_TOKEN: ${HF_TOKEN:-}
      HUGGING_FACE_HUB_TOKEN: ${HUGGING_FACE_HUB_TOKEN:-}
      WANDB_API_KEY: ${WANDB_API_KEY:-}
      TIKTOKEN_ENCODINGS_BASE: /data/hf_cache/tiktoken-encodings
      TIKTOKEN_RS_CACHE_DIR: /data/hf_cache/tiktoken-rs-cache
    gpus: all
    ipc: host
    command: ["sleep", "infinity"]
